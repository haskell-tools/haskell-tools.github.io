<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE ScopedTypeVariables
<span class="lineno">    2 </span>           , OverloadedStrings
<span class="lineno">    3 </span>           , DeriveGeneric
<span class="lineno">    4 </span>           , LambdaCase
<span class="lineno">    5 </span>           , TemplateHaskell
<span class="lineno">    6 </span>           , FlexibleContexts
<span class="lineno">    7 </span>           , MultiWayIf
<span class="lineno">    8 </span>           , TypeApplications
<span class="lineno">    9 </span>           , TypeFamilies
<span class="lineno">   10 </span>           , RecordWildCards
<span class="lineno">   11 </span>           #-}
<span class="lineno">   12 </span>-- | The central module for the background process of Haskell-tools. Starts the daemon process and
<span class="lineno">   13 </span>-- updates it for each client request in a loop. After this releases the resources and terminates.
<span class="lineno">   14 </span>module Language.Haskell.Tools.Daemon where
<span class="lineno">   15 </span>
<span class="lineno">   16 </span>import Control.Concurrent.MVar
<span class="lineno">   17 </span>import Control.Exception
<span class="lineno">   18 </span>import Control.Monad
<span class="lineno">   19 </span>import Control.Monad.State.Strict
<span class="lineno">   20 </span>import Control.Reference hiding (modifyMVarMasked_)
<span class="lineno">   21 </span>import Data.List
<span class="lineno">   22 </span>import Data.Maybe
<span class="lineno">   23 </span>import Data.Tuple
<span class="lineno">   24 </span>import Data.Version
<span class="lineno">   25 </span>import Network.Socket hiding (send, sendTo, recv, recvFrom, KeepAlive)
<span class="lineno">   26 </span>import System.IO
<span class="lineno">   27 </span>import System.IO.Error
<span class="lineno">   28 </span>
<span class="lineno">   29 </span>import Bag
<span class="lineno">   30 </span>import ErrUtils (ErrMsg(..))
<span class="lineno">   31 </span>import GhcMonad (Session(..), reflectGhc)
<span class="lineno">   32 </span>import HscTypes
<span class="lineno">   33 </span>import SrcLoc
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>import Language.Haskell.Tools.Daemon.GetModules
<span class="lineno">   36 </span>import Language.Haskell.Tools.Daemon.Mode
<span class="lineno">   37 </span>import Language.Haskell.Tools.Daemon.Protocol
<span class="lineno">   38 </span>import Language.Haskell.Tools.Daemon.Representation
<span class="lineno">   39 </span>import Language.Haskell.Tools.Daemon.State
<span class="lineno">   40 </span>import Language.Haskell.Tools.Daemon.Update
<span class="lineno">   41 </span>import Language.Haskell.Tools.Daemon.Watch
<span class="lineno">   42 </span>import Language.Haskell.Tools.Refactor
<span class="lineno">   43 </span>import Paths_haskell_tools_daemon
<span class="lineno">   44 </span>
<span class="lineno">   45 </span>-- | Starts the daemon process. This will not return until the daemon stops. You can use this entry
<span class="lineno">   46 </span>-- point when the other endpoint of the client connection is not needed, for example, when you use
<span class="lineno">   47 </span>-- socket connection to connect to the daemon process.
<span class="lineno">   48 </span>runDaemon' :: [RefactoringChoice IdDom] -&gt; DaemonOptions -&gt; IO ()
<span class="lineno">   49 </span><span class="decl"><span class="istickedoff">runDaemon' refactorings args = do store &lt;- newEmptyMVar</span>
<span class="lineno">   50 </span><span class="spaces">                                  </span><span class="istickedoff">runDaemon refactorings socketMode store args</span></span>
<span class="lineno">   51 </span>
<span class="lineno">   52 </span>-- | Command line options for the daemon process.
<span class="lineno">   53 </span>data DaemonOptions = DaemonOptions { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">daemonVersion</span></span></span> :: Bool
<span class="lineno">   54 </span>                                   , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">portNumber</span></span></span> :: Int
<span class="lineno">   55 </span>                                   , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">silentMode</span></span></span> :: Bool
<span class="lineno">   56 </span>                                   , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">noWatch</span></span></span> :: Bool
<span class="lineno">   57 </span>                                   , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">watchExe</span></span></span> :: Maybe FilePath
<span class="lineno">   58 </span>                                   }
<span class="lineno">   59 </span>
<span class="lineno">   60 </span>-- | Starts the daemon process. This will not return until the daemon stops.
<span class="lineno">   61 </span>-- The daemon process is parameterized by the refactorings you can use in it. This entry point gives
<span class="lineno">   62 </span>-- back the other endpoint of the connection so it can be used to run the daemon in the same process.
<span class="lineno">   63 </span>runDaemon :: [RefactoringChoice IdDom] -&gt; WorkingMode a -&gt; MVar a -&gt; DaemonOptions -&gt; IO ()
<span class="lineno">   64 </span><span class="decl"><span class="istickedoff">runDaemon _ _ _ DaemonOptions{..} | <span class="tickonlyfalse">daemonVersion</span></span>
<span class="lineno">   65 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">putStrLn $ showVersion version</span></span>
<span class="lineno">   66 </span><span class="spaces"></span><span class="istickedoff">runDaemon refactorings mode connStore DaemonOptions{..} = withSocketsDo $</span>
<span class="lineno">   67 </span><span class="spaces">    </span><span class="istickedoff">do when (not silentMode) $ <span class="nottickedoff">putStrLn $ &quot;Starting Haskell Tools daemon&quot;</span></span>
<span class="lineno">   68 </span><span class="spaces">       </span><span class="istickedoff">conn &lt;- daemonConnect mode portNumber</span>
<span class="lineno">   69 </span><span class="spaces">       </span><span class="istickedoff">putMVar connStore conn</span>
<span class="lineno">   70 </span><span class="spaces">       </span><span class="istickedoff">when (not silentMode) $ <span class="nottickedoff">putStrLn $ &quot;Connection established&quot;</span></span>
<span class="lineno">   71 </span><span class="spaces">       </span><span class="istickedoff">ghcSess &lt;- initGhcSession</span>
<span class="lineno">   72 </span><span class="spaces">       </span><span class="istickedoff">state &lt;- newMVar initSession</span>
<span class="lineno">   73 </span><span class="spaces">       </span><span class="istickedoff">(wp,th) &lt;- if <span class="tickonlytrue">noWatch</span> then return (Nothing, <span class="nottickedoff">[]</span>)</span>
<span class="lineno">   74 </span><span class="spaces">                             </span><span class="istickedoff">else <span class="nottickedoff">createWatchProcess' watchExe ghcSess state (daemonSend mode conn)</span></span>
<span class="lineno">   75 </span><span class="spaces">       </span><span class="istickedoff">modifyMVarMasked_ state ( \s -&gt; return s { _watchProc = wp, _watchThreads = <span class="nottickedoff">th</span> })</span>
<span class="lineno">   76 </span><span class="spaces">       </span><span class="istickedoff">serverLoop refactorings mode conn silentMode ghcSess state</span>
<span class="lineno">   77 </span><span class="spaces">       </span><span class="istickedoff">case wp of Just watchProcess -&gt; <span class="nottickedoff">stopWatch watchProcess th</span></span>
<span class="lineno">   78 </span><span class="spaces">                  </span><span class="istickedoff">Nothing -&gt; return <span class="nottickedoff">()</span></span>
<span class="lineno">   79 </span><span class="spaces">       </span><span class="istickedoff">daemonDisconnect mode conn</span></span>
<span class="lineno">   80 </span>
<span class="lineno">   81 </span>-- | Starts the server loop, receiving requests from the client and updated the server state
<span class="lineno">   82 </span>-- according to these.
<span class="lineno">   83 </span>serverLoop :: [RefactoringChoice IdDom] -&gt; WorkingMode a -&gt; a -&gt; Bool -&gt; Session
<span class="lineno">   84 </span>                -&gt; MVar DaemonSessionState -&gt; IO ()
<span class="lineno">   85 </span><span class="decl"><span class="istickedoff">serverLoop refactorings mode conn isSilent ghcSess state =</span>
<span class="lineno">   86 </span><span class="spaces">  </span><span class="istickedoff">do msgs &lt;- daemonReceive mode conn</span>
<span class="lineno">   87 </span><span class="spaces">     </span><span class="istickedoff">continue &lt;- mapM respondToMsg msgs</span>
<span class="lineno">   88 </span><span class="spaces">     </span><span class="istickedoff">sessionData &lt;- readMVar state</span>
<span class="lineno">   89 </span><span class="spaces">     </span><span class="istickedoff">when (not (sessionData ^. exiting) &amp;&amp; all (== True) continue)</span>
<span class="lineno">   90 </span><span class="spaces">       </span><span class="istickedoff">$ serverLoop refactorings mode conn isSilent ghcSess state</span>
<span class="lineno">   91 </span><span class="spaces">   </span><span class="istickedoff">`catches` <span class="nottickedoff">exceptionHandlers (serverLoop refactorings mode conn isSilent ghcSess state)</span></span>
<span class="lineno">   92 </span><span class="spaces">                               </span><span class="istickedoff"><span class="nottickedoff">(daemonSend mode conn . ErrorMessage)</span></span>
<span class="lineno">   93 </span><span class="spaces">  </span><span class="istickedoff">where respondToMsg (Right req)</span>
<span class="lineno">   94 </span><span class="spaces">          </span><span class="istickedoff">= do when (not isSilent) $ <span class="nottickedoff">putStrLn $ &quot;Message received: &quot; ++ show req</span></span>
<span class="lineno">   95 </span><span class="spaces">               </span><span class="istickedoff">respondTo refactorings ghcSess state (daemonSend mode conn) req</span>
<span class="lineno">   96 </span><span class="spaces">           </span><span class="istickedoff">`catches` userExceptionHandlers</span>
<span class="lineno">   97 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff">(\s -&gt; daemonSend mode conn (ErrorMessage s) &gt;&gt; return True)</span></span>
<span class="lineno">   98 </span><span class="spaces">                        </span><span class="istickedoff">(\err hint -&gt; daemonSend mode conn (CompilationProblem err hint) &gt;&gt; return True)</span>
<span class="lineno">   99 </span><span class="spaces">        </span><span class="istickedoff">respondToMsg (Left msg) = <span class="nottickedoff">do daemonSend mode conn $ ErrorMessage $ &quot;MALFORMED MESSAGE: &quot; ++ msg</span></span>
<span class="lineno">  100 </span><span class="spaces">                                     </span><span class="istickedoff"><span class="nottickedoff">return True</span></span></span>
<span class="lineno">  101 </span>
<span class="lineno">  102 </span>-- | Responds to a client request by modifying the daemon and GHC state accordingly.
<span class="lineno">  103 </span>respondTo :: [RefactoringChoice IdDom] -&gt;  Session -&gt; MVar DaemonSessionState
<span class="lineno">  104 </span>               -&gt; (ResponseMsg -&gt; IO ()) -&gt; ClientMessage -&gt; IO Bool
<span class="lineno">  105 </span><span class="decl"><span class="istickedoff">respondTo refactorings ghcSess state next req</span>
<span class="lineno">  106 </span><span class="spaces">  </span><span class="istickedoff">= modifyMVar state (\st -&gt; swap &lt;$&gt; reflectGhc (runStateT (updateClient refactorings next req) st) ghcSess)</span></span>
<span class="lineno">  107 </span>
<span class="lineno">  108 </span>userExceptionHandlers :: (String -&gt; IO Bool) -&gt; ([(SrcSpan, String)] -&gt; [String] -&gt; IO Bool) -&gt; [Handler Bool]
<span class="lineno">  109 </span><span class="decl"><span class="istickedoff">userExceptionHandlers sendError sendCompProblems =</span>
<span class="lineno">  110 </span><span class="spaces">  </span><span class="istickedoff">[ Handler <span class="nottickedoff">(\(UnsupportedPackage e) -&gt; sendError (&quot;There are unsupported elements in your package: &quot; ++ e ++ &quot; please correct them before loading them into Haskell-tools.&quot;))</span></span>
<span class="lineno">  111 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(UnsupportedExtension e) -&gt; sendError (&quot;The extension you use is not supported: &quot; ++ e ++ &quot;. Please check your source and cabal files for the use of that language extension.&quot;))</span></span>
<span class="lineno">  112 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(SpliceInsertionProblem rng _) -&gt; sendError (&quot;A problem occurred while type-checking the Template Haskell splice at: &quot; ++ shortShowSpan rng ++ &quot;. Some complex splices cannot be type checked for reasons currently unknown. Please simplify the splice. We are working on this problem.&quot;))</span></span>
<span class="lineno">  113 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\case (BreakUpProblem outer rng _) -&gt; sendError (&quot;The program element at &quot; ++ (if isGoodSrcSpan rng then shortShowSpanWithFile rng else shortShowSpanWithFile (RealSrcSpan outer)) ++ &quot; could not be prepared for refactoring. The most likely reason is preprocessor usage. Only conditional compilation is supported, includes and preprocessor macros are not. If there is no preprocessor usage at the given location, there might be a weirdly placed comment causing a problem.&quot;))</span></span>
<span class="lineno">  114 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(TransformationProblem msg) -&gt; sendError (&quot;A problem occurred while preparing the program for refactoring: &quot; ++ msg))</span></span>
<span class="lineno">  115 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(PrettyPrintProblem msg) -&gt; sendError (&quot;A problem occurred while pretty printing the result of the refactoring: &quot; ++ msg))</span></span>
<span class="lineno">  116 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\case (ConvertionProblem rng msg) -&gt; sendError (&quot;An unexpected problem occurred while converting the representation of the program element at &quot; ++ shortShowSpan rng ++ &quot;: &quot; ++ msg)</span></span>
<span class="lineno">  117 </span><span class="spaces">                   </span><span class="istickedoff"><span class="nottickedoff">(UnrootedConvertionProblem msg) -&gt; sendError (&quot;An unexpected problem occurred while converting between different program representations: &quot; ++ msg))</span></span>
<span class="lineno">  118 </span><span class="spaces">  </span><span class="istickedoff">, Handler (\errs -&gt; let msgs = map (\err -&gt; (errMsgSpan err, show err))</span>
<span class="lineno">  119 </span><span class="spaces">                                   </span><span class="istickedoff">$ bagToList $ srcErrorMessages errs</span>
<span class="lineno">  120 </span><span class="spaces">                          </span><span class="istickedoff">hints = nub $ sort $ catMaybes $ map (handleSourceProblem . snd) msgs</span>
<span class="lineno">  121 </span><span class="spaces">                       </span><span class="istickedoff">in sendCompProblems msgs hints)</span>
<span class="lineno">  122 </span><span class="spaces">  </span><span class="istickedoff">]</span></span>
<span class="lineno">  123 </span>
<span class="lineno">  124 </span>exceptionHandlers :: IO () -&gt; (String -&gt; IO ()) -&gt; [Handler ()]
<span class="lineno">  125 </span><span class="decl"><span class="nottickedoff">exceptionHandlers cont sendError =</span>
<span class="lineno">  126 </span><span class="spaces">  </span><span class="nottickedoff">[ Handler (\(err :: IOException) -&gt; hPutStrLn stderr $ &quot;IO Exception caught: &quot; ++ show err)</span>
<span class="lineno">  127 </span><span class="spaces">  </span><span class="nottickedoff">, Handler (\(e :: AsyncException) -&gt; hPutStrLn stderr $ &quot;Asynch exception caught: &quot; ++ show e)</span>
<span class="lineno">  128 </span><span class="spaces">  </span><span class="nottickedoff">, Handler (\(ex :: SomeException) -&gt; handleException ex cont)</span>
<span class="lineno">  129 </span><span class="spaces">  </span><span class="nottickedoff">]</span>
<span class="lineno">  130 </span><span class="spaces">  </span><span class="nottickedoff">where handleException ex cont</span>
<span class="lineno">  131 </span><span class="spaces">          </span><span class="nottickedoff">= case handleGHCException (show ex) of</span>
<span class="lineno">  132 </span><span class="spaces">              </span><span class="nottickedoff">Nothing -&gt; do hPutStrLn stderr $ &quot;Unexpected error: &quot; ++ show (ex :: SomeException)</span>
<span class="lineno">  133 </span><span class="spaces">                            </span><span class="nottickedoff">sendError $ &quot;Internal error: &quot; ++ show ex</span>
<span class="lineno">  134 </span><span class="spaces">              </span><span class="nottickedoff">Just (msg, doContinue) -&gt; sendError msg &gt;&gt; when doContinue cont</span></span>
<span class="lineno">  135 </span>
<span class="lineno">  136 </span>handleGHCException :: String -&gt; Maybe (String, Bool)
<span class="lineno">  137 </span><span class="decl"><span class="nottickedoff">handleGHCException msg | &quot;failed&quot; `isInfixOf` msg &amp;&amp; &quot;C pre-processor&quot; `isInfixOf` msg</span>
<span class="lineno">  138 </span><span class="spaces">  </span><span class="nottickedoff">= Just (&quot;Failed to load the package. The cause of that is a failure of the pre-processor. &quot;</span>
<span class="lineno">  139 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot; Only conditional compilation is supported, includes and preprocessor macros are not: &quot; ++ msg, False)</span>
<span class="lineno">  140 </span><span class="spaces"></span><span class="nottickedoff">handleGHCException msg | &quot;failed&quot; `isInfixOf` msg &amp;&amp; &quot;Literate pre-processor&quot; `isInfixOf` msg</span>
<span class="lineno">  141 </span><span class="spaces">  </span><span class="nottickedoff">= Just (&quot;Haskell-tools does not handle Literate Haskell yet.&quot;</span>
<span class="lineno">  142 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot; If you get this error after refactoring, you should undo the refactoring. The error message: &quot; ++ msg, True)</span>
<span class="lineno">  143 </span><span class="spaces"></span><span class="nottickedoff">handleGHCException msg = Nothing</span></span>
<span class="lineno">  144 </span>
<span class="lineno">  145 </span>handleSourceProblem :: String -&gt; Maybe String
<span class="lineno">  146 </span><span class="decl"><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;is a package module&quot; `isInfixOf` msg</span></span>
<span class="lineno">  147 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;A module is not found, check that the current working directory is the root of the module hierarchy. &quot;</span></span>
<span class="lineno">  148 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot; Also check that none of the modules are generated by parser generators or hsc files.&quot;</span></span>
<span class="lineno">  149 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;Failed to load interface&quot; `isInfixOf` msg</span></span>
<span class="lineno">  150 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;Some of the required (external) modules cannot be loaded, because they are not found. Make sure that the project is &quot;</span></span>
<span class="lineno">  151 </span><span class="spaces">              </span><span class="istickedoff"><span class="nottickedoff">++ &quot; already built, and that it is built using the same package database as it is used for refactoring.&quot;</span></span>
<span class="lineno">  152 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;Ambiguous interface&quot; `isInfixOf` msg</span></span>
<span class="lineno">  153 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;Some of the required (external) modules cannot be loaded, because they are ambiguous. &quot;</span></span>
<span class="lineno">  154 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot;Since there is no separation between packages and package components, make sure that you do not depend &quot;</span></span>
<span class="lineno">  155 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot;on packages that contain modules with the same qualified name.&quot;</span></span>
<span class="lineno">  156 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem _</span>
<span class="lineno">  157 </span><span class="spaces">  </span><span class="istickedoff">= Just $ &quot;While loading we found a compilation error in the source code. If it compiles normally &quot;</span>
<span class="lineno">  158 </span><span class="spaces">              </span><span class="istickedoff">++ &quot;using cabal or stack the problem might result from modules with same name, or &quot;</span>
<span class="lineno">  159 </span><span class="spaces">              </span><span class="istickedoff">++ &quot;generated files that are not up-to-date.&quot;</span></span>

</pre>
</body>
</html>
