<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE LambdaCase #-}
<span class="lineno">    2 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">    3 </span>
<span class="lineno">    4 </span>-- | Handlers for common errors in Haskell-tools daemon.
<span class="lineno">    5 </span>module Language.Haskell.Tools.Daemon.ErrorHandling where
<span class="lineno">    6 </span>
<span class="lineno">    7 </span>import Bag (bagToList)
<span class="lineno">    8 </span>import Control.Exception
<span class="lineno">    9 </span>import Control.Monad (Monad(..), when)
<span class="lineno">   10 </span>import Data.List
<span class="lineno">   11 </span>import Data.Maybe (Maybe(..), catMaybes)
<span class="lineno">   12 </span>import ErrUtils (ErrMsg(..))
<span class="lineno">   13 </span>import HscTypes (SourceError, srcErrorMessages)
<span class="lineno">   14 </span>import SrcLoc (SrcSpan(..), isGoodSrcSpan)
<span class="lineno">   15 </span>import System.IO (IO, hPutStrLn, stderr)
<span class="lineno">   16 </span>
<span class="lineno">   17 </span>import Language.Haskell.Tools.Daemon.Protocol
<span class="lineno">   18 </span>import Language.Haskell.Tools.Daemon.GetModules (UnsupportedPackage(..))
<span class="lineno">   19 </span>import Language.Haskell.Tools.Refactor
<span class="lineno">   20 </span>
<span class="lineno">   21 </span>-- Handlers for exceptions specific to our application.
<span class="lineno">   22 </span>userExceptionHandlers :: (String -&gt; IO a) -&gt; ([Marker] -&gt; [String] -&gt; IO a) -&gt; [Handler a]
<span class="lineno">   23 </span><span class="decl"><span class="istickedoff">userExceptionHandlers sendError sendCompProblems =</span>
<span class="lineno">   24 </span><span class="spaces">  </span><span class="istickedoff">[ Handler <span class="nottickedoff">(\(UnsupportedPackage e) -&gt; sendError (&quot;There are unsupported elements in your package: &quot; ++ e ++ &quot; please correct them before loading them into Haskell-tools.&quot;))</span></span>
<span class="lineno">   25 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(UnsupportedExtension e) -&gt; sendError (&quot;The extension you use is not supported: &quot; ++ e ++ &quot;. Please check your source and cabal files for the use of that language extension.&quot;))</span></span>
<span class="lineno">   26 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(SpliceInsertionProblem rng e) -&gt; sendError (&quot;A problem occurred:&quot; ++ e ++ &quot;\nWhile type-checking the Template Haskell splice at: &quot; ++ shortShowSpanWithFile rng ++ &quot;. Some complex splices cannot be type checked for reasons currently unknown. Please simplify the splice. We are working on this problem.&quot;))</span></span>
<span class="lineno">   27 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\case (BreakUpProblem outer rng _) -&gt; sendError (&quot;The program element at &quot; ++ (if isGoodSrcSpan rng then shortShowSpanWithFile rng else shortShowSpanWithFile (RealSrcSpan outer)) ++ &quot; could not be prepared for refactoring. The most likely reason is preprocessor usage. Only conditional compilation is supported, includes and preprocessor macros are not. If there is no preprocessor usage at the given location, there might be a weirdly placed comment causing a problem.&quot;))</span></span>
<span class="lineno">   28 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(TransformationProblem msg) -&gt; sendError (&quot;A problem occurred while preparing the program for refactoring: &quot; ++ msg))</span></span>
<span class="lineno">   29 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\(PrettyPrintProblem msg) -&gt; sendError (&quot;A problem occurred while pretty printing the result of the refactoring: &quot; ++ msg))</span></span>
<span class="lineno">   30 </span><span class="spaces">  </span><span class="istickedoff">, Handler <span class="nottickedoff">(\case (ConvertionProblem _ rng msg) -&gt; sendError (&quot;An unexpected problem occurred while converting the representation of the program element at &quot; ++ shortShowSpanWithFile rng ++ &quot;: &quot; ++ msg)</span></span>
<span class="lineno">   31 </span><span class="spaces">                   </span><span class="istickedoff"><span class="nottickedoff">(UnrootedConvertionProblem msg) -&gt; sendError (&quot;An unexpected problem occurred while converting between different program representations: &quot; ++ msg))</span></span>
<span class="lineno">   32 </span><span class="spaces">  </span><span class="istickedoff">, Handler (uncurry sendCompProblems . getProblems)</span>
<span class="lineno">   33 </span><span class="spaces">  </span><span class="istickedoff">]</span></span>
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>-- | Handlers for generic exceptions: 'IOException', 'AsyncException', 'SomeException'.
<span class="lineno">   36 </span>exceptionHandlers :: IO () -&gt; (String -&gt; IO ()) -&gt; [Handler ()]
<span class="lineno">   37 </span><span class="decl"><span class="nottickedoff">exceptionHandlers cont sendError =</span>
<span class="lineno">   38 </span><span class="spaces">  </span><span class="nottickedoff">[ Handler (\(err :: IOException) -&gt; hPutStrLn stderr $ &quot;IO Exception caught: &quot; ++ show err)</span>
<span class="lineno">   39 </span><span class="spaces">  </span><span class="nottickedoff">, Handler (\(e :: AsyncException) -&gt; hPutStrLn stderr $ &quot;Asynch exception caught: &quot; ++ show e)</span>
<span class="lineno">   40 </span><span class="spaces">  </span><span class="nottickedoff">, Handler (\(ex :: SomeException) -&gt; handleException ex cont)</span>
<span class="lineno">   41 </span><span class="spaces">  </span><span class="nottickedoff">]</span>
<span class="lineno">   42 </span><span class="spaces">  </span><span class="nottickedoff">where handleException ex cont</span>
<span class="lineno">   43 </span><span class="spaces">          </span><span class="nottickedoff">= case handleGHCException (show ex) of</span>
<span class="lineno">   44 </span><span class="spaces">              </span><span class="nottickedoff">Nothing -&gt; do hPutStrLn stderr $ &quot;Unexpected error: &quot; ++ show (ex :: SomeException)</span>
<span class="lineno">   45 </span><span class="spaces">                            </span><span class="nottickedoff">sendError $ &quot;Internal error: &quot; ++ show ex</span>
<span class="lineno">   46 </span><span class="spaces">              </span><span class="nottickedoff">Just (msg, doContinue) -&gt; sendError msg &gt;&gt; when doContinue cont</span></span>
<span class="lineno">   47 </span>
<span class="lineno">   48 </span>getProblems :: SourceError -&gt; ([Marker], [String])
<span class="lineno">   49 </span><span class="decl"><span class="istickedoff">getProblems errs = let msgs = map (\err -&gt; Marker (errMsgSpan err) Error (show err))</span>
<span class="lineno">   50 </span><span class="spaces">                                 </span><span class="istickedoff">$ bagToList $ srcErrorMessages errs</span>
<span class="lineno">   51 </span><span class="spaces">                       </span><span class="istickedoff">hints = nub $ sort $ catMaybes $ map (handleSourceProblem . message) msgs</span>
<span class="lineno">   52 </span><span class="spaces">                    </span><span class="istickedoff">in (msgs, hints)</span></span>
<span class="lineno">   53 </span>
<span class="lineno">   54 </span>-- | Hint text and continuation suggestion for different kinds of errors based on pattern matching on error text.
<span class="lineno">   55 </span>handleGHCException :: String -&gt; Maybe (String, Bool)
<span class="lineno">   56 </span><span class="decl"><span class="nottickedoff">handleGHCException msg | &quot;failed&quot; `isInfixOf` msg &amp;&amp; &quot;C pre-processor&quot; `isInfixOf` msg</span>
<span class="lineno">   57 </span><span class="spaces">  </span><span class="nottickedoff">= Just (&quot;Failed to load the package. The cause of that is a failure of the pre-processor. &quot;</span>
<span class="lineno">   58 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot; Only conditional compilation is supported, includes and preprocessor macros are not: &quot; ++ msg, False)</span>
<span class="lineno">   59 </span><span class="spaces"></span><span class="nottickedoff">handleGHCException msg | &quot;failed&quot; `isInfixOf` msg &amp;&amp; &quot;Literate pre-processor&quot; `isInfixOf` msg</span>
<span class="lineno">   60 </span><span class="spaces">  </span><span class="nottickedoff">= Just (&quot;Haskell-tools does not handle Literate Haskell yet.&quot;</span>
<span class="lineno">   61 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot; If you get this error after refactoring, you should undo the refactoring. The error message: &quot; ++ msg, True)</span>
<span class="lineno">   62 </span><span class="spaces"></span><span class="nottickedoff">handleGHCException msg | &quot;cannot satisfy&quot; `isInfixOf` msg</span>
<span class="lineno">   63 </span><span class="spaces">  </span><span class="nottickedoff">= Just (&quot;While trying to collect the modules of the project we found the a package is not in the&quot;</span>
<span class="lineno">   64 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot; used package database. Check that you actually compiled this package with all of its components (tests, benchmarks). &quot;</span>
<span class="lineno">   65 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot;If so, make sure that it is installed with the same tools that the project is &quot;</span>
<span class="lineno">   66 </span><span class="spaces">             </span><span class="nottickedoff">++ &quot;configured for (cabal/stack/cabal sandbox). The error message: &quot; ++ msg, True)</span>
<span class="lineno">   67 </span><span class="spaces"></span><span class="nottickedoff">handleGHCException _ = Nothing</span></span>
<span class="lineno">   68 </span>
<span class="lineno">   69 </span>-- | Hint text and continuation suggestion for different kinds of source problems based on pattern matching on error text.
<span class="lineno">   70 </span>handleSourceProblem :: String -&gt; Maybe String
<span class="lineno">   71 </span><span class="decl"><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;is a package module&quot; `isInfixOf` msg</span></span>
<span class="lineno">   72 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;A module is not found, check that the current working directory is the root of the module hierarchy. &quot;</span></span>
<span class="lineno">   73 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot; Also check that none of the modules are generated by parser generators or hsc files.&quot;</span></span>
<span class="lineno">   74 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;Failed to load interface&quot; `isInfixOf` msg</span></span>
<span class="lineno">   75 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;Some of the required (external) modules cannot be loaded, because they are not found. Make sure that the project is &quot;</span></span>
<span class="lineno">   76 </span><span class="spaces">              </span><span class="istickedoff"><span class="nottickedoff">++ &quot; already built, and that it is built using the same package database as it is used for refactoring.&quot;</span></span>
<span class="lineno">   77 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem msg | <span class="tickonlyfalse">&quot;Ambiguous interface&quot; `isInfixOf` msg</span></span>
<span class="lineno">   78 </span><span class="spaces">  </span><span class="istickedoff">= <span class="nottickedoff">Just $ &quot;Some of the required (external) modules cannot be loaded, because they are ambiguous. &quot;</span></span>
<span class="lineno">   79 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot;Since there is no separation between packages and package components, make sure that you do not depend &quot;</span></span>
<span class="lineno">   80 </span><span class="spaces">             </span><span class="istickedoff"><span class="nottickedoff">++ &quot;on packages that contain modules with the same qualified name.&quot;</span></span>
<span class="lineno">   81 </span><span class="spaces"></span><span class="istickedoff">handleSourceProblem _</span>
<span class="lineno">   82 </span><span class="spaces">  </span><span class="istickedoff">= Just $ &quot;While loading we found a compilation error in the source code. If it compiles normally &quot;</span>
<span class="lineno">   83 </span><span class="spaces">              </span><span class="istickedoff">++ &quot;using cabal or stack the problem might result from modules with same name, or &quot;</span>
<span class="lineno">   84 </span><span class="spaces">              </span><span class="istickedoff">++ &quot;generated files that are not up-to-date.&quot;</span></span>

</pre>
</body>
</html>
