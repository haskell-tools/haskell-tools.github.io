<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Kind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">returnsConstraintKind</span><span class="hs-special">)</span><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">checkValidClsArgs</span><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTyConName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Name</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Generics.Uniplate.Data</span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Generics.Uniplate.Operations</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Reference</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.Tools.AST</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.Tools.Refactor</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html"><span class="hs-identifier">Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad</span></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-identifier">gblChkQNamesForFC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-22"></a><a name="gblChkQNamesForFC"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#gblChkQNamesForFC"><span class="hs-identifier">gblChkQNamesForFC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#conditional"><span class="hs-identifier hs-var">conditional</span></a><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#gblChkQNamesForFC%27"><span class="hs-identifier hs-var">gblChkQNamesForFC'</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-identifier">chkFlexibleContexts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Context</span><span>
</span><a name="line-25"></a><a name="chkFlexibleContexts"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContexts"><span class="hs-identifier">chkFlexibleContexts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#conditional"><span class="hs-identifier hs-var">conditional</span></a><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContexts%27"><span class="hs-identifier hs-var">chkFlexibleContexts'</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-identifier">chkFlexibleContexts'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Context</span><span>
</span><a name="line-28"></a><a name="chkFlexibleContexts%27"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContexts%27"><span class="hs-identifier">chkFlexibleContexts'</span></a></a><span> </span><a name="local-6989586621679224573"><a href="#local-6989586621679224573"><span class="hs-identifier">ctx</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Context</span><span> </span><a name="local-6989586621679224574"><a href="#local-6989586621679224574"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkAssertion"><span class="hs-identifier hs-var">chkAssertion</span></a><span> </span><a href="#local-6989586621679224574"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224573"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-identifier">chkAssertion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Assertion</span><span>
</span><a name="line-31"></a><a name="chkAssertion"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkAssertion"><span class="hs-identifier">chkAssertion</span></a></a><span> </span><a name="local-6989586621679224575"><a href="#local-6989586621679224575"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClassAssert</span><span> </span><a name="local-6989586621679224576"><a href="#local-6989586621679224576"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621679224577"><a href="#local-6989586621679224577"><span class="hs-identifier">annTys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-comment">-- If a lookup fails, add MissingInformation FlexibleContexts</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679224578"><a href="#local-6989586621679224578"><span class="hs-identifier">errDefault</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addMI"><span class="hs-identifier hs-var">addMI</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span> </span><a href="#local-6989586621679224575"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-34"></a><span>  </span><a name="local-6989586621679224579"><a href="#local-6989586621679224579"><span class="hs-identifier">isClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromMaybeTM</span><span> </span><a href="#local-6989586621679224578"><span class="hs-identifier hs-var">errDefault</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isClassTyConNameM</span><span> </span><a href="#local-6989586621679224576"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679224579"><span class="hs-identifier hs-var">isClass</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">hasTyVarHead</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224577"><span class="hs-identifier hs-var">annTys</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">annListElems</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224575"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addEvidence"><span class="hs-identifier hs-var">addEvidence</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span> </span><a href="#local-6989586621679224575"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-38"></a><span class="hs-identifier">chkAssertion</span><span> </span><a name="local-6989586621679224580"><a href="#local-6989586621679224580"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixAssert</span><span> </span><a name="local-6989586621679224581"><a href="#local-6989586621679224581"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621679224582"><a href="#local-6989586621679224582"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621679224583"><a href="#local-6989586621679224583"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-comment">-- If the constraint is of form a ~ b, then we dont need to check</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679224584"><a href="#local-6989586621679224584"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span> </span><a href="#local-6989586621679224582"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679224584"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">eqTyConName</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224580"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-comment">-- If the constraint has only type variable heads, it doesn't need FlexibleContexts</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">hasTyVarHead</span><span> </span><a href="#local-6989586621679224581"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">hasTyVarHead</span><span> </span><a href="#local-6989586621679224583"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224580"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-comment">-- In any other case, we keep FlexibleContexts</span><span>
</span><a name="line-46"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addEvidence"><span class="hs-identifier hs-var">addEvidence</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span> </span><a href="#local-6989586621679224580"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-47"></a><span class="hs-identifier">chkAssertion</span><span> </span><a name="local-6989586621679224585"><a href="#local-6989586621679224585"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TupleAssert</span><span> </span><a name="local-6989586621679224586"><a href="#local-6989586621679224586"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkAssertion"><span class="hs-identifier hs-var">chkAssertion</span></a><span> </span><a href="#local-6989586621679224586"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224585"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-50"></a><span class="hs-identifier">chkAssertion</span><span> </span><a name="local-6989586621679224587"><a href="#local-6989586621679224587"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">ImplicitAssert</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224587"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">chkFlexibleContextsDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Decl</span><span>
</span><a name="line-53"></a><a name="chkFlexibleContextsDecl"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContextsDecl"><span class="hs-identifier">chkFlexibleContextsDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#conditional"><span class="hs-identifier hs-var">conditional</span></a><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContextsDecl%27"><span class="hs-identifier hs-var">chkFlexibleContextsDecl'</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-identifier">chkFlexibleContextsDecl'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Decl</span><span>
</span><a name="line-56"></a><a name="chkFlexibleContextsDecl%27"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkFlexibleContextsDecl%27"><span class="hs-identifier">chkFlexibleContextsDecl'</span></a></a><span> </span><a name="local-6989586621679224588"><a href="#local-6989586621679224588"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeDecl</span><span> </span><a name="local-6989586621679224589"><a href="#local-6989586621679224589"><span class="hs-identifier">dh</span></a></a><span> </span><a name="local-6989586621679224590"><a href="#local-6989586621679224590"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679224591"><a href="#local-6989586621679224591"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeOrKindFromId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">declHeadQName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679224589"><span class="hs-identifier hs-var">dh</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hasConstraintKind</span><span> </span><a href="#local-6989586621679224591"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">returnsConstraintKind</span><span> </span><a href="#local-6989586621679224591"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>       </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkClassesInside"><span class="hs-identifier hs-var">chkClassesInside</span></a><span> </span><a href="#local-6989586621679224590"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224588"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-61"></a><span class="hs-identifier">chkFlexibleContextsDecl'</span><span> </span><a name="local-6989586621679224592"><a href="#local-6989586621679224592"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224592"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- | Checks whether all type class applications in a type synonym rhs</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- (that has kind Constraint) have only type variable heads.</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- Returns False if a lookup inside is not succesful.</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- If it isn't applied to a type that has kind Constraint, it may give</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- false positive results.</span><span>
</span><a name="line-68"></a><span class="hs-identifier">chkClassesInside</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#ExtMonad"><span class="hs-identifier hs-type">ExtMonad</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><a name="chkClassesInside"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkClassesInside"><span class="hs-identifier">chkClassesInside</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TupleType</span><span> </span><a name="local-6989586621679224593"><a href="#local-6989586621679224593"><span class="hs-identifier">annTys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkClassesInside"><span class="hs-identifier hs-var">chkClassesInside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224593"><span class="hs-identifier hs-var">annTys</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">annListElems</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-identifier">chkClassesInside</span><span> </span><a name="local-6989586621679224594"><a href="#local-6989586621679224594"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224595"><span class="hs-identifier hs-var">addFC</span></a><span> </span><a href="#local-6989586621679224594"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224596"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224597"><span class="hs-identifier hs-var">splitTypeAppMaybe</span></a><span> </span><a href="#local-6989586621679224594"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">addFC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#ExtMonad"><span class="hs-identifier hs-type">ExtMonad</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>    </span><a name="local-6989586621679224595"><a href="#local-6989586621679224595"><span class="hs-identifier">addFC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addEvidence_"><span class="hs-identifier hs-var">addEvidence_</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GHC.Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#ExtMonad"><span class="hs-identifier hs-type">ExtMonad</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>    </span><a name="local-6989586621679224596"><a href="#local-6989586621679224596"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679224598"><a href="#local-6989586621679224598"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621679224599"><a href="#local-6989586621679224599"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>       </span><a name="local-6989586621679224600"><a href="#local-6989586621679224600"><span class="hs-identifier">isClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isJustT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lookupClass</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679224598"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-79"></a><span>       </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224598"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">eqTyConName</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679224600"><span class="hs-identifier hs-var">isClass</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">hasTyVarHead</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224599"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621679224595"><span class="hs-identifier hs-var">addFC</span></a><span> </span><a href="#local-6989586621679224594"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-comment">-- Separates the type into its head and its arguments.</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-comment">-- This functions should only be applied to types that have kind Constraint.</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GHC.Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>    </span><a name="local-6989586621679224597"><a href="#local-6989586621679224597"><span class="hs-identifier">splitTypeAppMaybe</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeApp</span><span> </span><a name="local-6989586621679224601"><a href="#local-6989586621679224601"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679224602"><a href="#local-6989586621679224602"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679224603"><a href="#local-6989586621679224603"><span class="hs-identifier">f'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679224604"><a href="#local-6989586621679224604"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679224597"><span class="hs-identifier hs-var">splitTypeAppMaybe</span></a><span> </span><a href="#local-6989586621679224601"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224603"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679224604"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679224602"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixTypeApp</span><span> </span><a name="local-6989586621679224605"><a href="#local-6989586621679224605"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621679224606"><a href="#local-6989586621679224606"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621679224607"><a href="#local-6989586621679224607"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>      </span><a name="local-6989586621679224608"><a href="#local-6989586621679224608"><span class="hs-identifier">opName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span> </span><a href="#local-6989586621679224606"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-90"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224608"><span class="hs-identifier hs-var">opName</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679224605"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">,</span><a href="#local-6989586621679224607"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarType</span><span> </span><a name="local-6989586621679224609"><a href="#local-6989586621679224609"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-92"></a><span>      </span><a name="local-6989586621679224610"><a href="#local-6989586621679224610"><span class="hs-identifier">sname</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span> </span><a href="#local-6989586621679224609"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-93"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224610"><span class="hs-identifier hs-var">sname</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParenType</span><span> </span><a name="local-6989586621679224611"><a href="#local-6989586621679224611"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224597"><span class="hs-identifier hs-var">splitTypeAppMaybe</span></a><span> </span><a href="#local-6989586621679224611"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-95"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindedType</span><span> </span><a name="local-6989586621679224612"><a href="#local-6989586621679224612"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224597"><span class="hs-identifier hs-var">splitTypeAppMaybe</span></a><span> </span><a href="#local-6989586621679224612"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-96"></a><span>    </span><span class="hs-identifier">splitTypeAppMaybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">chkQNameForFC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QualifiedName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#ExtMonad"><span class="hs-identifier hs-type">ExtMonad</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-100"></a><a name="chkQNameForFC"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkQNameForFC"><span class="hs-identifier">chkQNameForFC</span></a></a><span> </span><a name="local-6989586621679224613"><a href="#local-6989586621679224613"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>  </span><a name="local-6989586621679224625"><a href="#local-6989586621679224625"><span class="hs-identifier">mty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lookupTypeFromId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679224613"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679224625"><span class="hs-identifier hs-var">mty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679224626"><a href="#local-6989586621679224626"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>      </span><span class="hs-comment">-- First we get all subtypes of the given type, while expanding all type synonyms,</span><span>
</span><a name="line-105"></a><span>      </span><span class="hs-comment">-- then we remove all implicit predicates,</span><span>
</span><a name="line-106"></a><span>      </span><span class="hs-comment">-- and partition the types into predicate types and theta types.</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679224627"><a href="#local-6989586621679224627"><span class="hs-identifier">expanded</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expandTypeSynonyms</span><span> </span><a href="#local-6989586621679224626"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-108"></a><span>          </span><a name="local-6989586621679224628"><a href="#local-6989586621679224628"><span class="hs-identifier">subTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">universeBi</span><span> </span><a href="#local-6989586621679224627"><span class="hs-identifier hs-var">expanded</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.Type</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679224629"><a href="#local-6989586621679224629"><span class="hs-identifier">preds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679224630"><a href="#local-6989586621679224630"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier hs-var">isPredTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isIPPred</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679224628"><span class="hs-identifier hs-var">subTys</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>          </span><span class="hs-comment">-- We don't need type equalities, so we get rid of them and their children.</span><span>
</span><a name="line-112"></a><span>          </span><span class="hs-comment">-- Then we extract the constraints from the types.</span><span>
</span><a name="line-113"></a><span>          </span><a name="local-6989586621679224631"><a href="#local-6989586621679224631"><span class="hs-identifier">nomEqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">universeBi</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679224616"><span class="hs-identifier hs-var">isNominalEqPred</span></a><span> </span><a href="#local-6989586621679224629"><span class="hs-identifier hs-var">preds</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.Type</span><span class="hs-special">]</span><span>
</span><a name="line-114"></a><span>          </span><a name="local-6989586621679224632"><a href="#local-6989586621679224632"><span class="hs-identifier">preds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224629"><span class="hs-identifier hs-var">preds</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679224631"><span class="hs-identifier hs-var">nomEqs</span></a><span>
</span><a name="line-115"></a><span>          </span><a name="local-6989586621679224633"><a href="#local-6989586621679224633"><span class="hs-identifier">thetas</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224615"><span class="hs-identifier hs-var">snd'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224630"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>          </span><span class="hs-comment">-- We split each theta type into its class tycon and its arguments.</span><span>
</span><a name="line-118"></a><span>          </span><span class="hs-comment">-- We also filter out tuple constraints</span><span>
</span><a name="line-119"></a><span>          </span><span class="hs-comment">-- (we already have the constraints in it).</span><span>
</span><a name="line-120"></a><span>          </span><a name="local-6989586621679224634"><a href="#local-6989586621679224634"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-identifier hs-var">getClassPredTys_maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224633"><span class="hs-identifier hs-var">thetas</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679224632"><span class="hs-identifier hs-var">preds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>          </span><a name="local-6989586621679224635"><a href="#local-6989586621679224635"><span class="hs-identifier">xs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224634"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621679224614"><span class="hs-identifier hs-var">hasValidClsArgs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224635"><span class="hs-identifier hs-var">xs'</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-124"></a><span>                                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-identifier">hasValidClsArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GHC.Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-128"></a><span>    </span><a name="local-6989586621679224614"><a href="#local-6989586621679224614"><span class="hs-identifier">hasValidClsArgs</span></a></a><span> </span><a name="local-6989586621679224620"><a href="#local-6989586621679224620"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621679224621"><a href="#local-6989586621679224621"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224620"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>
</span><a name="line-129"></a><span>                            </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isIPClass</span><span> </span><a href="#local-6989586621679224620"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-130"></a><span>                            </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">checkValidClsArgs</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679224620"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621679224621"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-identifier">snd'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224617"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679224618"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679224619"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679224618"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-133"></a><span>    </span><a name="local-6989586621679224615"><a href="#local-6989586621679224615"><span class="hs-identifier">snd'</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679224622"><a href="#local-6989586621679224622"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224622"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier">isNominalEqPred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-136"></a><span>    </span><a name="local-6989586621679224616"><a href="#local-6989586621679224616"><span class="hs-identifier">isNominalEqPred</span></a></a><span> </span><a name="local-6989586621679224623"><a href="#local-6989586621679224623"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-137"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679224624"><a href="#local-6989586621679224624"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621679224623"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679224624"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>
</span><a name="line-138"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-identifier">gblChkQNamesForFC'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#CheckNode"><span class="hs-identifier hs-type">CheckNode</span></a><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-141"></a><a name="gblChkQNamesForFC%27"><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#gblChkQNamesForFC%27"><span class="hs-identifier">gblChkQNamesForFC'</span></a></a><span> </span><a name="local-6989586621679224636"><a href="#local-6989586621679224636"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-comment">-- Names appearing on the rhs of bindings are just hints,</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-comment">-- they don't necessarily require FlexibleContexts.</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679224637"><a href="#local-6989586621679224637"><span class="hs-identifier">allNames</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">universeBi</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224636"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">modDecl</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QualifiedName</span><span class="hs-special">]</span><span>
</span><a name="line-145"></a><span>      </span><a name="local-6989586621679224638"><a href="#local-6989586621679224638"><span class="hs-identifier">rhs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">universeBi</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224636"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">modDecl</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Rhs</span><span class="hs-special">]</span><span>
</span><a name="line-146"></a><span>      </span><a name="local-6989586621679224639"><a href="#local-6989586621679224639"><span class="hs-identifier">hints</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">universeBi</span><span> </span><a href="#local-6989586621679224638"><span class="hs-identifier hs-var">rhs</span></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QualifiedName</span><span class="hs-special">]</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>      </span><span class="hs-comment">-- Separating hints from evidence,</span><span>
</span><a name="line-149"></a><span>      </span><span class="hs-comment">-- and grouping them together based on their GHC.Name</span><span>
</span><a name="line-150"></a><span>      </span><a name="local-6989586621679224640"><a href="#local-6989586621679224640"><span class="hs-identifier">evidence</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679224637"><span class="hs-identifier hs-var">allNames</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679224639"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>      </span><a name="local-6989586621679224641"><a href="#local-6989586621679224641"><span class="hs-identifier">hints'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224639"><span class="hs-identifier hs-var">hints</span></a><span>
</span><a name="line-152"></a><span>      </span><a name="local-6989586621679224642"><a href="#local-6989586621679224642"><span class="hs-identifier">groupedEs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">equivalenceGroupsBy</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span> </span><a href="#local-6989586621679224640"><span class="hs-identifier hs-var">evidence</span></a><span>
</span><a name="line-153"></a><span>      </span><a name="local-6989586621679224643"><a href="#local-6989586621679224643"><span class="hs-identifier">groupedHs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">equivalenceGroupsBy</span><span> </span><span class="hs-identifier hs-var">semanticsName</span><span> </span><a href="#local-6989586621679224641"><span class="hs-identifier hs-var">hints'</span></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>  </span><span class="hs-comment">-- Checking the representative elements, whether they need FC,</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-comment">-- if they do, add occurences for every node in their group.</span><span>
</span><a name="line-157"></a><span>  </span><a name="local-6989586621679224644"><a href="#local-6989586621679224644"><span class="hs-identifier">es</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkQNameForFC"><span class="hs-identifier hs-var">chkQNameForFC</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224642"><span class="hs-identifier hs-var">groupedEs</span></a><span>
</span><a name="line-158"></a><span>  </span><a name="local-6989586621679224645"><a href="#local-6989586621679224645"><span class="hs-identifier">hs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.Checkers.FlexibleContextsChecker.html#chkQNameForFC"><span class="hs-identifier hs-var">chkQNameForFC</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679224643"><span class="hs-identifier hs-var">groupedHs</span></a><span>
</span><a name="line-159"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addEvidence"><span class="hs-identifier hs-var">addEvidence</span></a><span> </span><span class="hs-identifier hs-var">FlexibleContexts</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679224644"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Builtin.ExtensionOrganizer.ExtMonad.html#addHint"><span class="hs-identifier hs-var">addHint</span></a><span>     </span><span class="hs-identifier hs-var">FlexibleContexts</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679224645"><span class="hs-identifier hs-var">hs</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679224636"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-163"></a></pre></body></html>