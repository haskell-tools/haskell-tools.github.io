<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE LambdaCase
           , ScopedTypeVariables
           #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Handlers for common errors in Haskell-tools daemon.</span><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">ErrorHandling</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Reference</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Tuple</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Socket</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">send</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sendTo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">recv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">recvFrom</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KeepAlive</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stderr</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ErrMsg</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcMonad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Session</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isGoodSrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.GetModules.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">GetModules</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.GetModules.html#UnsupportedPackage"><span class="hs-identifier hs-type">UnsupportedPackage</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Refactor</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- Handlers for exceptions specific to our application.</span><span>
</span><a name="line-26"></a><span class="hs-identifier">userExceptionHandlers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679319863"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679319863"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Handler</span><span> </span><a href="#local-6989586621679319863"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-27"></a><a name="userExceptionHandlers"><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#userExceptionHandlers"><span class="hs-identifier">userExceptionHandlers</span></a></a><span> </span><a name="local-6989586621679319864"><a href="#local-6989586621679319864"><span class="hs-identifier">sendError</span></a></a><span> </span><a name="local-6989586621679319865"><a href="#local-6989586621679319865"><span class="hs-identifier">sendCompProblems</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.GetModules.html#UnsupportedPackage"><span class="hs-identifier hs-var">UnsupportedPackage</span></a><span> </span><a name="local-6989586621679319866"><a href="#local-6989586621679319866"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;There are unsupported elements in your package: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679319866"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; please correct them before loading them into Haskell-tools.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnsupportedExtension</span><span> </span><a name="local-6989586621679320121"><a href="#local-6989586621679320121"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;The extension you use is not supported: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320121"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;. Please check your source and cabal files for the use of that language extension.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceInsertionProblem</span><span> </span><a name="local-6989586621679320296"><a href="#local-6989586621679320296"><span class="hs-identifier">rng</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while type-checking the Template Haskell splice at: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><a href="#local-6989586621679320296"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;. Some complex splices cannot be type checked for reasons currently unknown. Please simplify the splice. We are working on this problem.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BreakUpProblem</span><span> </span><a name="local-6989586621679320480"><a href="#local-6989586621679320480"><span class="hs-identifier">outer</span></a></a><span> </span><a name="local-6989586621679320481"><a href="#local-6989586621679320481"><span class="hs-identifier">rng</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;The program element at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isGoodSrcSpan</span><span> </span><a href="#local-6989586621679320481"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><a href="#local-6989586621679320481"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a href="#local-6989586621679320480"><span class="hs-identifier hs-var">outer</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; could not be prepared for refactoring. The most likely reason is preprocessor usage. Only conditional compilation is supported, includes and preprocessor macros are not. If there is no preprocessor usage at the given location, there might be a weirdly placed comment causing a problem.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransformationProblem</span><span> </span><a name="local-6989586621679320482"><a href="#local-6989586621679320482"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while preparing the program for refactoring: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320482"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrettyPrintProblem</span><span> </span><a name="local-6989586621679320717"><a href="#local-6989586621679320717"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while pretty printing the result of the refactoring: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320717"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConvertionProblem</span><span> </span><a name="local-6989586621679320718"><a href="#local-6989586621679320718"><span class="hs-identifier">rng</span></a></a><span> </span><a name="local-6989586621679320719"><a href="#local-6989586621679320719"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;An unexpected problem occurred while converting the representation of the program element at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><a href="#local-6989586621679320718"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320719"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnrootedConvertionProblem</span><span> </span><a name="local-6989586621679320720"><a href="#local-6989586621679320720"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679319864"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;An unexpected problem occurred while converting between different program representations: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320720"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621679319865"><span class="hs-identifier hs-var">sendCompProblems</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#getProblems"><span class="hs-identifier hs-var">getProblems</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-comment">-- | Handlers for generic exceptions: 'IOException', 'AsyncException', 'SomeException'.</span><span>
</span><a name="line-40"></a><span class="hs-identifier">exceptionHandlers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-41"></a><a name="exceptionHandlers"><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#exceptionHandlers"><span class="hs-identifier">exceptionHandlers</span></a></a><span> </span><a name="local-6989586621679320721"><a href="#local-6989586621679320721"><span class="hs-identifier">cont</span></a></a><span> </span><a name="local-6989586621679320722"><a href="#local-6989586621679320722"><span class="hs-identifier">sendError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679320956"><a href="#local-6989586621679320956"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IOException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;IO Exception caught: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679320956"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679320957"><a href="#local-6989586621679320957"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AsyncException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Asynch exception caught: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679320957"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679320958"><a href="#local-6989586621679320958"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679320723"><span class="hs-identifier hs-var">handleException</span></a><span> </span><a href="#local-6989586621679320958"><span class="hs-identifier hs-var">ex</span></a><span> </span><a href="#local-6989586621679320721"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-46"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679320723"><a href="#local-6989586621679320723"><span class="hs-identifier">handleException</span></a></a><span> </span><a name="local-6989586621679320724"><a href="#local-6989586621679320724"><span class="hs-identifier">ex</span></a></a><span> </span><a name="local-6989586621679320725"><a href="#local-6989586621679320725"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-47"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#handleGHCException"><span class="hs-identifier hs-var">handleGHCException</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679320724"><span class="hs-identifier hs-var">ex</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-48"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Unexpected error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679320724"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>                            </span><a href="#local-6989586621679320722"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Internal error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679320724"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-50"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679320954"><a href="#local-6989586621679320954"><span class="hs-identifier">msg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679320955"><a href="#local-6989586621679320955"><span class="hs-identifier">doContinue</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679320722"><span class="hs-identifier hs-var">sendError</span></a><span> </span><a href="#local-6989586621679320954"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679320955"><span class="hs-identifier hs-var">doContinue</span></a><span> </span><a href="#local-6989586621679320725"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">getProblems</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SourceError</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><a name="getProblems"><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#getProblems"><span class="hs-identifier">getProblems</span></a></a><span> </span><a name="local-6989586621679320959"><a href="#local-6989586621679320959"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679320960"><a href="#local-6989586621679320960"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679320962"><a href="#local-6989586621679320962"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">errMsgSpan</span><span> </span><a href="#local-6989586621679320962"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679320962"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>                                 </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">srcErrorMessages</span><span> </span><a href="#local-6989586621679320959"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-55"></a><span>                       </span><a name="local-6989586621679320961"><a href="#local-6989586621679320961"><span class="hs-identifier">hints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#handleSourceProblem"><span class="hs-identifier hs-var">handleSourceProblem</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679320960"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-56"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679320960"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679320961"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- | Hint text and continuation suggestion for different kinds of errors based on pattern matching on error text.</span><span>
</span><a name="line-59"></a><span class="hs-identifier">handleGHCException</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><a name="handleGHCException"><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#handleGHCException"><span class="hs-identifier">handleGHCException</span></a></a><span> </span><a name="local-6989586621679320963"><a href="#local-6989586621679320963"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;failed&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320963"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-string">&quot;C pre-processor&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320963"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Failed to load the package. The cause of that is a failure of the pre-processor. &quot;</span><span>
</span><a name="line-62"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; Only conditional compilation is supported, includes and preprocessor macros are not: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320963"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-identifier">handleGHCException</span><span> </span><a name="local-6989586621679320964"><a href="#local-6989586621679320964"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;failed&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320964"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-string">&quot;Literate pre-processor&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320964"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Haskell-tools does not handle Literate Haskell yet.&quot;</span><span>
</span><a name="line-65"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; If you get this error after refactoring, you should undo the refactoring. The error message: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320964"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-identifier">handleGHCException</span><span> </span><a name="local-6989586621679320965"><a href="#local-6989586621679320965"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;cannot satisfy&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320965"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-67"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;While trying to collect the modules of the project we found the a package is not in the&quot;</span><span>
</span><a name="line-68"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; used package database. Check that you actually compiled this package with all of its components (tests, benchmarks). &quot;</span><span>
</span><a name="line-69"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;If so, make sure that it is installed with the same tools that the project is &quot;</span><span>
</span><a name="line-70"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;configured for (cabal/stack/cabal sandbox). The error message: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679320965"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-identifier">handleGHCException</span><span> </span><a name="local-6989586621679320966"><a href="#local-6989586621679320966"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | Hint text and continuation suggestion for different kinds of source problems based on pattern matching on error text.</span><span>
</span><a name="line-74"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-75"></a><a name="handleSourceProblem"><a href="Language.Haskell.Tools.Daemon.ErrorHandling.html#handleSourceProblem"><span class="hs-identifier">handleSourceProblem</span></a></a><span> </span><a name="local-6989586621679320967"><a href="#local-6989586621679320967"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;is a package module&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320967"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-76"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;A module is not found, check that the current working directory is the root of the module hierarchy. &quot;</span><span>
</span><a name="line-77"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; Also check that none of the modules are generated by parser generators or hsc files.&quot;</span><span>
</span><a name="line-78"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><a name="local-6989586621679320968"><a href="#local-6989586621679320968"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Failed to load interface&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320968"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Some of the required (external) modules cannot be loaded, because they are not found. Make sure that the project is &quot;</span><span>
</span><a name="line-80"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; already built, and that it is built using the same package database as it is used for refactoring.&quot;</span><span>
</span><a name="line-81"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><a name="local-6989586621679320969"><a href="#local-6989586621679320969"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Ambiguous interface&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679320969"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Some of the required (external) modules cannot be loaded, because they are ambiguous. &quot;</span><span>
</span><a name="line-83"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Since there is no separation between packages and package components, make sure that you do not depend &quot;</span><span>
</span><a name="line-84"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;on packages that contain modules with the same qualified name.&quot;</span><span>
</span><a name="line-85"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;While loading we found a compilation error in the source code. If it compiles normally &quot;</span><span>
</span><a name="line-87"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;using cabal or stack the problem might result from modules with same name, or &quot;</span><span>
</span><a name="line-88"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;generated files that are not up-to-date.&quot;</span><span>
</span><a name="line-89"></a></pre></body></html>