<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards
           , TypeSynonymInstances
           , FlexibleInstances
           , TemplateHaskell
           #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- | Representation of modules, their collections, refactoring changes and exceptions.</span><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Refactor</span><span class="hs-operator">.</span><span class="hs-identifier">Representation</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Reference</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">Split</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Typeable</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">FilePath</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">AST</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">AST</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">-- | A type for the input and result of refactoring a module</span><span>
</span><a name="line-23"></a><span class="hs-keyword">type</span><span> </span><a name="UnnamedModule"><a href="Language.Haskell.Tools.Refactor.Representation.html#UnnamedModule"><span class="hs-identifier">UnnamedModule</span></a></a><span> </span><a name="local-6989586621679084848"><a href="#local-6989586621679084848"><span class="hs-identifier">dom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ann</span><span> </span><span class="hs-identifier hs-type">AST</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">UModule</span><span> </span><a href="#local-6989586621679084848"><span class="hs-identifier hs-type">dom</span></a><span> </span><span class="hs-identifier hs-type">SrcTemplateStage</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- | The name of the module and the AST</span><span>
</span><a name="line-26"></a><span class="hs-keyword">type</span><span> </span><a name="ModuleDom"><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleDom"><span class="hs-identifier">ModuleDom</span></a></a><span> </span><a name="local-6989586621679084847"><a href="#local-6989586621679084847"><span class="hs-identifier">dom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceFileKey"><span class="hs-identifier hs-type">SourceFileKey</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.Tools.Refactor.Representation.html#UnnamedModule"><span class="hs-identifier hs-type">UnnamedModule</span></a><span> </span><a href="#local-6989586621679084847"><span class="hs-identifier hs-type">dom</span></a><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-comment">-- | Module name and marker to separate .hs-boot module definitions. Specifies a source file in a working directory.</span><span>
</span><a name="line-29"></a><span class="hs-keyword">data</span><span> </span><a name="SourceFileKey"><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceFileKey"><span class="hs-identifier">SourceFileKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SourceFileKey"><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceFileKey"><span class="hs-identifier">SourceFileKey</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="_sfkFileName"><a href="Language.Haskell.Tools.Refactor.Representation.html#_sfkFileName"><span class="hs-identifier">_sfkFileName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-30"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="_sfkModuleName"><a href="Language.Haskell.Tools.Refactor.Representation.html#_sfkModuleName"><span class="hs-identifier">_sfkModuleName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-31"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- | Change in the project, modification or removal of a module.</span><span>
</span><a name="line-35"></a><span class="hs-keyword">data</span><span> </span><a name="RefactorChange"><a href="Language.Haskell.Tools.Refactor.Representation.html#RefactorChange"><span class="hs-identifier">RefactorChange</span></a></a><span> </span><a name="local-6989586621679080842"><a href="#local-6989586621679080842"><span class="hs-identifier">dom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ContentChanged"><a href="Language.Haskell.Tools.Refactor.Representation.html#ContentChanged"><span class="hs-identifier">ContentChanged</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="fromContentChanged"><a href="Language.Haskell.Tools.Refactor.Representation.html#fromContentChanged"><span class="hs-identifier">fromContentChanged</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleDom"><span class="hs-identifier hs-type">ModuleDom</span></a><span> </span><a href="#local-6989586621679080842"><span class="hs-identifier hs-type">dom</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-36"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="ModuleRemoved"><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleRemoved"><span class="hs-identifier">ModuleRemoved</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="removedModuleName"><a href="Language.Haskell.Tools.Refactor.Representation.html#removedModuleName"><span class="hs-identifier">removedModuleName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-37"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="ModuleCreated"><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleCreated"><span class="hs-identifier">ModuleCreated</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="createdModuleName"><a href="Language.Haskell.Tools.Refactor.Representation.html#createdModuleName"><span class="hs-identifier">createdModuleName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-38"></a><span>                                        </span><span class="hs-special">,</span><span> </span><a name="createdModuleContent"><a href="Language.Haskell.Tools.Refactor.Representation.html#createdModuleContent"><span class="hs-identifier">createdModuleContent</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Representation.html#UnnamedModule"><span class="hs-identifier hs-type">UnnamedModule</span></a><span> </span><a href="#local-6989586621679080842"><span class="hs-identifier hs-type">dom</span></a><span>
</span><a name="line-39"></a><span>                                        </span><span class="hs-special">,</span><span> </span><a name="sameLocation"><a href="Language.Haskell.Tools.Refactor.Representation.html#sameLocation"><span class="hs-identifier">sameLocation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceFileKey"><span class="hs-identifier hs-type">SourceFileKey</span></a><span>
</span><a name="line-40"></a><span>                                        </span><span class="hs-special">}</span><span>
</span><a name="line-41"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#RefactorChange"><span class="hs-identifier hs-type">RefactorChange</span></a><span> </span><a href="#local-6989586621679087995"><span class="hs-identifier hs-type">dom</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>  </span><a name="local-8214565720323785461"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#ContentChanged"><span class="hs-identifier hs-var">ContentChanged</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679087996"><a href="#local-6989586621679087996"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;ContentChanged (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679087996"><span class="hs-identifier hs-var">n</span></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleRemoved"><span class="hs-identifier hs-var">ModuleRemoved</span></a><span> </span><a name="local-6989586621679087997"><a href="#local-6989586621679087997"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;ModuleRemoved &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679087997"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#ModuleCreated"><span class="hs-identifier hs-var">ModuleCreated</span></a><span> </span><a name="local-6989586621679087998"><a href="#local-6989586621679087998"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679087999"><a href="#local-6989586621679087999"><span class="hs-identifier">other</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;ModuleCreated &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679087998"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679087999"><span class="hs-identifier hs-var">other</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">-- | Exceptions that can occur while loading modules or during internal operations (not during performing the refactor).</span><span>
</span><a name="line-47"></a><span class="hs-keyword">data</span><span> </span><a name="RefactorException"><a href="Language.Haskell.Tools.Refactor.Representation.html#RefactorException"><span class="hs-identifier">RefactorException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IllegalExtensions"><a href="Language.Haskell.Tools.Refactor.Representation.html#IllegalExtensions"><span class="hs-identifier">IllegalExtensions</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-48"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="SourceCodeProblem"><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceCodeProblem"><span class="hs-identifier">SourceCodeProblem</span></a></a><span> </span><span class="hs-identifier hs-type">ErrorMessages</span><span>
</span><a name="line-49"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="UnknownException"><a href="Language.Haskell.Tools.Refactor.Representation.html#UnknownException"><span class="hs-identifier">UnknownException</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-identifier hs-type">ErrorMessages</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-53"></a><span>  </span><a name="local-8214565720323785461"><span class="hs-identifier">show</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Language.Haskell.Tools.Refactor.Representation.html#RefactorException"><span class="hs-identifier hs-type">RefactorException</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-56"></a><span>  </span><a name="local-8214565720323789174"><span class="hs-identifier">displayException</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#SourceCodeProblem"><span class="hs-identifier hs-var">SourceCodeProblem</span></a><span> </span><a name="local-6989586621679086889"><a href="#local-6989586621679086889"><span class="hs-identifier">prob</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Source code problem: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">showSDocUnsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprErrMsgBagWithLoc</span><span> </span><a href="#local-6989586621679086889"><span class="hs-identifier hs-var">prob</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>  </span><span class="hs-identifier">displayException</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#IllegalExtensions"><span class="hs-identifier hs-var">IllegalExtensions</span></a><span> </span><a name="local-6989586621679086890"><a href="#local-6989586621679086890"><span class="hs-identifier">exts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;The following extensions are not allowed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">intersperse</span><span> </span><span class="hs-string">&quot;, &quot;</span><span> </span><a href="#local-6989586621679086890"><span class="hs-identifier hs-var">exts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier">displayException</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Refactor.Representation.html#UnknownException"><span class="hs-identifier hs-var">UnknownException</span></a><span> </span><a name="local-6989586621679087994"><a href="#local-6989586621679087994"><span class="hs-identifier">ex</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;An unexpected problem appeared: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679087994"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Transforms module name to a .hs file name relative to the source root directory.</span><span>
</span><a name="line-63"></a><span class="hs-identifier">moduleSourceFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-64"></a><a name="moduleSourceFile"><a href="Language.Haskell.Tools.Refactor.Representation.html#moduleSourceFile"><span class="hs-identifier">moduleSourceFile</span></a></a><span> </span><a name="local-6989586621679088000"><a href="#local-6989586621679088000"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl1</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitOn</span><span> </span><span class="hs-string">&quot;.&quot;</span><span> </span><a href="#local-6989586621679088000"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;hs&quot;</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- | Transforms a source root relative file name into module name.</span><span>
</span><a name="line-67"></a><span class="hs-identifier">sourceFileModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-68"></a><a name="sourceFileModule"><a href="Language.Haskell.Tools.Refactor.Representation.html#sourceFileModule"><span class="hs-identifier">sourceFileModule</span></a></a><span> </span><a name="local-6989586621679088533"><a href="#local-6989586621679088533"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;.&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">splitDirectories</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621679088533"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier hs-var">makeReferences</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">SourceFileKey</span><span>
</span><a name="line-71"></a></pre></body></html>