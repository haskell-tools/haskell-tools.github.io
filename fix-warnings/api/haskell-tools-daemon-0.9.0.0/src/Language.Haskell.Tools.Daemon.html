<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables
           , OverloadedStrings
           , DeriveGeneric
           , LambdaCase
           , TemplateHaskell
           , FlexibleContexts
           , MultiWayIf
           , TypeApplications
           , TypeFamilies
           , RecordWildCards
           #-}</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- | The central module for the background process of Haskell-tools. Starts the daemon process and</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- updates it for each client request in a loop. After this releases the resources and terminates.</span><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Reference</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Tuple</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Version</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Socket</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">send</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sendTo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">recv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">recvFrom</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">KeepAlive</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ErrMsg</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcMonad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Session</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reflectGhc</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.GetModules.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">GetModules</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.Mode.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.Protocol.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.Representation.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">Representation</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.State.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">State</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.Update.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">Update</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.Tools.Daemon.Watch.html"><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Daemon</span><span class="hs-operator">.</span><span class="hs-identifier">Watch</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">Tools</span><span class="hs-operator">.</span><span class="hs-identifier">Refactor</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Paths_haskell_tools_daemon.html"><span class="hs-identifier">Paths_haskell_tools_daemon</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- | Starts the daemon process. This will not return until the daemon stops. You can use this entry</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- point when the other endpoint of the client connection is not needed, for example, when you use</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- socket connection to connect to the daemon process.</span><span>
</span><a name="line-48"></a><span class="hs-identifier">runDaemon'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RefactoringChoice</span><span> </span><span class="hs-identifier hs-type">IdDom</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier hs-type">DaemonOptions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><a name="runDaemon%27"><a href="Language.Haskell.Tools.Daemon.html#runDaemon%27"><span class="hs-identifier">runDaemon'</span></a></a><span> </span><a name="local-6989586621679365783"><a href="#local-6989586621679365783"><span class="hs-identifier">refactorings</span></a></a><span> </span><a name="local-6989586621679365784"><a href="#local-6989586621679365784"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679365785"><a href="#local-6989586621679365785"><span class="hs-identifier">store</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-50"></a><span>                                  </span><a href="Language.Haskell.Tools.Daemon.html#runDaemon"><span class="hs-identifier hs-var">runDaemon</span></a><span> </span><a href="#local-6989586621679365783"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="Language.Haskell.Tools.Daemon.Mode.html#socketMode"><span class="hs-identifier hs-var">socketMode</span></a><span> </span><a href="#local-6989586621679365785"><span class="hs-identifier hs-var">store</span></a><span> </span><a href="#local-6989586621679365784"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-comment">-- | Command line options for the daemon process.</span><span>
</span><a name="line-53"></a><span class="hs-keyword">data</span><span> </span><a name="DaemonOptions"><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier">DaemonOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DaemonOptions"><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier">DaemonOptions</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="daemonVersion"><a href="Language.Haskell.Tools.Daemon.html#daemonVersion"><span class="hs-identifier">daemonVersion</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-54"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="portNumber"><a href="Language.Haskell.Tools.Daemon.html#portNumber"><span class="hs-identifier">portNumber</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-55"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="silentMode"><a href="Language.Haskell.Tools.Daemon.html#silentMode"><span class="hs-identifier">silentMode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-56"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="noWatch"><a href="Language.Haskell.Tools.Daemon.html#noWatch"><span class="hs-identifier">noWatch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-57"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="watchExe"><a href="Language.Haskell.Tools.Daemon.html#watchExe"><span class="hs-identifier">watchExe</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-58"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- | Starts the daemon process. This will not return until the daemon stops.</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- The daemon process is parameterized by the refactorings you can use in it. This entry point gives</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- back the other endpoint of the connection so it can be used to run the daemon in the same process.</span><span>
</span><a name="line-63"></a><span class="hs-identifier">runDaemon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RefactoringChoice</span><span> </span><span class="hs-identifier hs-type">IdDom</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.Mode.html#WorkingMode"><span class="hs-identifier hs-type">WorkingMode</span></a><span> </span><a href="#local-6989586621679365782"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="#local-6989586621679365782"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier hs-type">DaemonOptions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><a name="runDaemon"><a href="Language.Haskell.Tools.Daemon.html#runDaemon"><span class="hs-identifier">runDaemon</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier hs-var">DaemonOptions</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679365786"><span class="hs-identifier hs-var">daemonVersion</span></a><span>
</span><a name="line-65"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showVersion</span><span> </span><a href="Paths_haskell_tools_daemon.html#version"><span class="hs-identifier hs-var">version</span></a><span>
</span><a name="line-66"></a><span class="hs-identifier">runDaemon</span><span> </span><a name="local-6989586621679365791"><a href="#local-6989586621679365791"><span class="hs-identifier">refactorings</span></a></a><span> </span><a name="local-6989586621679365792"><a href="#local-6989586621679365792"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679365793"><a href="#local-6989586621679365793"><span class="hs-identifier">connStore</span></a></a><span> </span><a href="Language.Haskell.Tools.Daemon.html#DaemonOptions"><span class="hs-identifier hs-var">DaemonOptions</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSocketsDo</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679365796"><span class="hs-identifier hs-var">silentMode</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Starting Haskell Tools daemon&quot;</span><span>
</span><a name="line-68"></a><span>       </span><a name="local-6989586621679365860"><a href="#local-6989586621679365860"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">daemonConnect</span><span> </span><a href="#local-6989586621679365792"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365795"><span class="hs-identifier hs-var">portNumber</span></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679365793"><span class="hs-identifier hs-var">connStore</span></a><span> </span><a href="#local-6989586621679365860"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-70"></a><span>       </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679365796"><span class="hs-identifier hs-var">silentMode</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Connection established&quot;</span><span>
</span><a name="line-71"></a><span>       </span><a name="local-6989586621679365861"><a href="#local-6989586621679365861"><span class="hs-identifier">ghcSess</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.Tools.Daemon.Update.html#initGhcSession"><span class="hs-identifier hs-var">initGhcSession</span></a><span>
</span><a name="line-72"></a><span>       </span><a name="local-6989586621679365862"><a href="#local-6989586621679365862"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Language.Haskell.Tools.Daemon.State.html#initSession"><span class="hs-identifier hs-var">initSession</span></a><span>
</span><a name="line-73"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621679365863"><a href="#local-6989586621679365863"><span class="hs-identifier">wp</span></a></a><span class="hs-special">,</span><a name="local-6989586621679365864"><a href="#local-6989586621679365864"><span class="hs-identifier">th</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679365797"><span class="hs-identifier hs-var">noWatch</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><a href="Language.Haskell.Tools.Daemon.Watch.html#createWatchProcess%27"><span class="hs-identifier hs-var">createWatchProcess'</span></a><span> </span><a href="#local-6989586621679365798"><span class="hs-identifier hs-var">watchExe</span></a><span> </span><a href="#local-6989586621679365861"><span class="hs-identifier hs-var">ghcSess</span></a><span> </span><a href="#local-6989586621679365862"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365792"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365860"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>       </span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span> </span><a href="#local-6989586621679365862"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679365865"><a href="#local-6989586621679365865"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679365865"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_watchProc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679365863"><span class="hs-identifier hs-var">wp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_watchThreads</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679365864"><span class="hs-identifier hs-var">th</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>       </span><a href="Language.Haskell.Tools.Daemon.html#serverLoop"><span class="hs-identifier hs-var">serverLoop</span></a><span> </span><a href="#local-6989586621679365791"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="#local-6989586621679365792"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365860"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679365796"><span class="hs-identifier hs-var">silentMode</span></a><span> </span><a href="#local-6989586621679365861"><span class="hs-identifier hs-var">ghcSess</span></a><span> </span><a href="#local-6989586621679365862"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-77"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679365863"><span class="hs-identifier hs-var">wp</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679365866"><a href="#local-6989586621679365866"><span class="hs-identifier">watchProcess</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.Watch.html#stopWatch"><span class="hs-identifier hs-var">stopWatch</span></a><span> </span><a href="#local-6989586621679365866"><span class="hs-identifier hs-var">watchProcess</span></a><span> </span><a href="#local-6989586621679365864"><span class="hs-identifier hs-var">th</span></a><span>
</span><a name="line-78"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>       </span><span class="hs-identifier">daemonDisconnect</span><span> </span><a href="#local-6989586621679365792"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365860"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- | Starts the server loop, receiving requests from the client and updated the server state</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- according to these.</span><span>
</span><a name="line-83"></a><span class="hs-identifier">serverLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RefactoringChoice</span><span> </span><span class="hs-identifier hs-type">IdDom</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.Mode.html#WorkingMode"><span class="hs-identifier hs-type">WorkingMode</span></a><span> </span><a href="#local-6989586621679365781"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365781"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Session</span><span>
</span><a name="line-84"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Language.Haskell.Tools.Daemon.State.html#DaemonSessionState"><span class="hs-identifier hs-type">DaemonSessionState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><a name="serverLoop"><a href="Language.Haskell.Tools.Daemon.html#serverLoop"><span class="hs-identifier">serverLoop</span></a></a><span> </span><a name="local-6989586621679365867"><a href="#local-6989586621679365867"><span class="hs-identifier">refactorings</span></a></a><span> </span><a name="local-6989586621679365868"><a href="#local-6989586621679365868"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679365869"><a href="#local-6989586621679365869"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679365870"><a href="#local-6989586621679365870"><span class="hs-identifier">isSilent</span></a></a><span> </span><a name="local-6989586621679365871"><a href="#local-6989586621679365871"><span class="hs-identifier">ghcSess</span></a></a><span> </span><a name="local-6989586621679365872"><a href="#local-6989586621679365872"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679365879"><a href="#local-6989586621679365879"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">daemonReceive</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-87"></a><span>     </span><a name="local-6989586621679365880"><a href="#local-6989586621679365880"><span class="hs-identifier">continue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679365873"><span class="hs-identifier hs-var">respondToMsg</span></a><span> </span><a href="#local-6989586621679365879"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-88"></a><span>     </span><a name="local-6989586621679365881"><a href="#local-6989586621679365881"><span class="hs-identifier">sessionData</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679365872"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-89"></a><span>     </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679365881"><span class="hs-identifier hs-var">sessionData</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Language.Haskell.Tools.Daemon.State.html#exiting"><span class="hs-identifier hs-var">exiting</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679365880"><span class="hs-identifier hs-var">continue</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>       </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#serverLoop"><span class="hs-identifier hs-var">serverLoop</span></a><span> </span><a href="#local-6989586621679365867"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679365870"><span class="hs-identifier hs-var">isSilent</span></a><span> </span><a href="#local-6989586621679365871"><span class="hs-identifier hs-var">ghcSess</span></a><span> </span><a href="#local-6989586621679365872"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-91"></a><span>   </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catches</span><span class="hs-special">`</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#exceptionHandlers"><span class="hs-identifier hs-var">exceptionHandlers</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.html#serverLoop"><span class="hs-identifier hs-var">serverLoop</span></a><span> </span><a href="#local-6989586621679365867"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679365870"><span class="hs-identifier hs-var">isSilent</span></a><span> </span><a href="#local-6989586621679365871"><span class="hs-identifier hs-var">ghcSess</span></a><span> </span><a href="#local-6989586621679365872"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Haskell.Tools.Daemon.Protocol.html#ErrorMessage"><span class="hs-identifier hs-var">ErrorMessage</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679365873"><a href="#local-6989586621679365873"><span class="hs-identifier">respondToMsg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679365874"><a href="#local-6989586621679365874"><span class="hs-identifier">req</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679365870"><span class="hs-identifier hs-var">isSilent</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Message received: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679365874"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-95"></a><span>               </span><a href="Language.Haskell.Tools.Daemon.html#respondTo"><span class="hs-identifier hs-var">respondTo</span></a><span> </span><a href="#local-6989586621679365867"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="#local-6989586621679365871"><span class="hs-identifier hs-var">ghcSess</span></a><span> </span><a href="#local-6989586621679365872"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679365874"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-96"></a><span>           </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catches</span><span class="hs-special">`</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#userExceptionHandlers"><span class="hs-identifier hs-var">userExceptionHandlers</span></a><span>
</span><a name="line-97"></a><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679365875"><a href="#local-6989586621679365875"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.Protocol.html#ErrorMessage"><span class="hs-identifier hs-var">ErrorMessage</span></a><span> </span><a href="#local-6989586621679365875"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679365876"><a href="#local-6989586621679365876"><span class="hs-identifier">err</span></a></a><span> </span><a name="local-6989586621679365877"><a href="#local-6989586621679365877"><span class="hs-identifier">hint</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.Protocol.html#CompilationProblem"><span class="hs-identifier hs-var">CompilationProblem</span></a><span> </span><a href="#local-6989586621679365876"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="#local-6989586621679365877"><span class="hs-identifier hs-var">hint</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-identifier">respondToMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679365878"><a href="#local-6989586621679365878"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">daemonSend</span><span> </span><a href="#local-6989586621679365868"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679365869"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Haskell.Tools.Daemon.Protocol.html#ErrorMessage"><span class="hs-identifier hs-var">ErrorMessage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;MALFORMED MESSAGE: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679365878"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-100"></a><span>                                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Responds to a client request by modifying the daemon and GHC state accordingly.</span><span>
</span><a name="line-103"></a><span class="hs-identifier">respondTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RefactoringChoice</span><span> </span><span class="hs-identifier hs-type">IdDom</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-type">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Language.Haskell.Tools.Daemon.State.html#DaemonSessionState"><span class="hs-identifier hs-type">DaemonSessionState</span></a><span>
</span><a name="line-104"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.Protocol.html#ResponseMsg"><span class="hs-identifier hs-type">ResponseMsg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.Tools.Daemon.Protocol.html#ClientMessage"><span class="hs-identifier hs-type">ClientMessage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-105"></a><a name="respondTo"><a href="Language.Haskell.Tools.Daemon.html#respondTo"><span class="hs-identifier">respondTo</span></a></a><span> </span><a name="local-6989586621679365882"><a href="#local-6989586621679365882"><span class="hs-identifier">refactorings</span></a></a><span> </span><a name="local-6989586621679365883"><a href="#local-6989586621679365883"><span class="hs-identifier">ghcSess</span></a></a><span> </span><a name="local-6989586621679365884"><a href="#local-6989586621679365884"><span class="hs-identifier">state</span></a></a><span> </span><a name="local-6989586621679365885"><a href="#local-6989586621679365885"><span class="hs-identifier">next</span></a></a><span> </span><a name="local-6989586621679365886"><a href="#local-6989586621679365886"><span class="hs-identifier">req</span></a></a><span>
</span><a name="line-106"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621679365884"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679365887"><a href="#local-6989586621679365887"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">swap</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">reflectGhc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">runStateT</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.Update.html#updateClient"><span class="hs-identifier hs-var">updateClient</span></a><span> </span><a href="#local-6989586621679365882"><span class="hs-identifier hs-var">refactorings</span></a><span> </span><a href="#local-6989586621679365885"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621679365886"><span class="hs-identifier hs-var">req</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679365887"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679365883"><span class="hs-identifier hs-var">ghcSess</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">userExceptionHandlers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Handler</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><a name="userExceptionHandlers"><a href="Language.Haskell.Tools.Daemon.html#userExceptionHandlers"><span class="hs-identifier">userExceptionHandlers</span></a></a><span> </span><a name="local-6989586621679365888"><a href="#local-6989586621679365888"><span class="hs-identifier">sendError</span></a></a><span> </span><a name="local-6989586621679365889"><a href="#local-6989586621679365889"><span class="hs-identifier">sendCompProblems</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.GetModules.html#UnsupportedPackage"><span class="hs-identifier hs-var">UnsupportedPackage</span></a><span> </span><a name="local-6989586621679365890"><a href="#local-6989586621679365890"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;There are unsupported elements in your package: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679365890"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; please correct them before loading them into Haskell-tools.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnsupportedExtension</span><span> </span><a name="local-6989586621679365891"><a href="#local-6989586621679365891"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;The extension you use is not supported: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679365891"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;. Please check your source and cabal files for the use of that language extension.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceInsertionProblem</span><span> </span><a name="local-6989586621679366066"><a href="#local-6989586621679366066"><span class="hs-identifier">rng</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while type-checking the Template Haskell splice at: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shortShowSpan</span><span> </span><a href="#local-6989586621679366066"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;. Some complex splices cannot be type checked for reasons currently unknown. Please simplify the splice. We are working on this problem.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BreakUpProblem</span><span> </span><a name="local-6989586621679366250"><a href="#local-6989586621679366250"><span class="hs-identifier">outer</span></a></a><span> </span><a name="local-6989586621679366251"><a href="#local-6989586621679366251"><span class="hs-identifier">rng</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;The program element at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isGoodSrcSpan</span><span> </span><a href="#local-6989586621679366251"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><a href="#local-6989586621679366251"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">shortShowSpanWithFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a href="#local-6989586621679366250"><span class="hs-identifier hs-var">outer</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; could not be prepared for refactoring. The most likely reason is preprocessor usage. Only conditional compilation is supported, includes and preprocessor macros are not. If there is no preprocessor usage at the given location, there might be a weirdly placed comment causing a problem.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransformationProblem</span><span> </span><a name="local-6989586621679366252"><a href="#local-6989586621679366252"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while preparing the program for refactoring: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366252"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrettyPrintProblem</span><span> </span><a name="local-6989586621679366485"><a href="#local-6989586621679366485"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;A problem occurred while pretty printing the result of the refactoring: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366485"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConvertionProblem</span><span> </span><a name="local-6989586621679366486"><a href="#local-6989586621679366486"><span class="hs-identifier">rng</span></a></a><span> </span><a name="local-6989586621679366487"><a href="#local-6989586621679366487"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;An unexpected problem occurred while converting the representation of the program element at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shortShowSpan</span><span> </span><a href="#local-6989586621679366486"><span class="hs-identifier hs-var">rng</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366487"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnrootedConvertionProblem</span><span> </span><a name="local-6989586621679366488"><a href="#local-6989586621679366488"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679365888"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;An unexpected problem occurred while converting between different program representations: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366488"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679366489"><a href="#local-6989586621679366489"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679366490"><a href="#local-6989586621679366490"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679366492"><a href="#local-6989586621679366492"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">errMsgSpan</span><span> </span><a href="#local-6989586621679366492"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679366492"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>                                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">srcErrorMessages</span><span> </span><a href="#local-6989586621679366489"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-120"></a><span>                          </span><a name="local-6989586621679366491"><a href="#local-6989586621679366491"><span class="hs-identifier">hints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.Tools.Daemon.html#handleSourceProblem"><span class="hs-identifier hs-var">handleSourceProblem</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679366490"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-121"></a><span>                       </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679365889"><span class="hs-identifier hs-var">sendCompProblems</span></a><span> </span><a href="#local-6989586621679366490"><span class="hs-identifier hs-var">msgs</span></a><span> </span><a href="#local-6989586621679366491"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">exceptionHandlers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-125"></a><a name="exceptionHandlers"><a href="Language.Haskell.Tools.Daemon.html#exceptionHandlers"><span class="hs-identifier">exceptionHandlers</span></a></a><span> </span><a name="local-6989586621679366493"><a href="#local-6989586621679366493"><span class="hs-identifier">cont</span></a></a><span> </span><a name="local-6989586621679366494"><a href="#local-6989586621679366494"><span class="hs-identifier">sendError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679366584"><a href="#local-6989586621679366584"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IOException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;IO Exception caught: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679366584"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679366585"><a href="#local-6989586621679366585"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AsyncException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Asynch exception caught: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679366585"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679366586"><a href="#local-6989586621679366586"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679366495"><span class="hs-identifier hs-var">handleException</span></a><span> </span><a href="#local-6989586621679366586"><span class="hs-identifier hs-var">ex</span></a><span> </span><a href="#local-6989586621679366493"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679366495"><a href="#local-6989586621679366495"><span class="hs-identifier">handleException</span></a></a><span> </span><a name="local-6989586621679366496"><a href="#local-6989586621679366496"><span class="hs-identifier">ex</span></a></a><span> </span><a name="local-6989586621679366497"><a href="#local-6989586621679366497"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-131"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Language.Haskell.Tools.Daemon.html#handleGHCException"><span class="hs-identifier hs-var">handleGHCException</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679366496"><span class="hs-identifier hs-var">ex</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-132"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">hPutStrLn</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Unexpected error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679366496"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>                            </span><a href="#local-6989586621679366494"><span class="hs-identifier hs-var">sendError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Internal error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679366496"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-134"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679366582"><a href="#local-6989586621679366582"><span class="hs-identifier">msg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679366583"><a href="#local-6989586621679366583"><span class="hs-identifier">doContinue</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679366494"><span class="hs-identifier hs-var">sendError</span></a><span> </span><a href="#local-6989586621679366582"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679366583"><span class="hs-identifier hs-var">doContinue</span></a><span> </span><a href="#local-6989586621679366497"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">handleGHCException</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><a name="handleGHCException"><a href="Language.Haskell.Tools.Daemon.html#handleGHCException"><span class="hs-identifier">handleGHCException</span></a></a><span> </span><a name="local-6989586621679366587"><a href="#local-6989586621679366587"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;failed&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366587"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-string">&quot;C pre-processor&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366587"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Failed to load the package. The cause of that is a failure of the pre-processor. &quot;</span><span>
</span><a name="line-139"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; Only conditional compilation is supported, includes and preprocessor macros are not: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366587"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span class="hs-identifier">handleGHCException</span><span> </span><a name="local-6989586621679366588"><a href="#local-6989586621679366588"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;failed&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366588"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-string">&quot;Literate pre-processor&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366588"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-141"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Haskell-tools does not handle Literate Haskell yet.&quot;</span><span>
</span><a name="line-142"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; If you get this error after refactoring, you should undo the refactoring. The error message: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679366588"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span class="hs-identifier">handleGHCException</span><span> </span><a name="local-6989586621679366589"><a href="#local-6989586621679366589"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-146"></a><a name="handleSourceProblem"><a href="Language.Haskell.Tools.Daemon.html#handleSourceProblem"><span class="hs-identifier">handleSourceProblem</span></a></a><span> </span><a name="local-6989586621679366590"><a href="#local-6989586621679366590"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;is a package module&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366590"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;A module is not found, check that the current working directory is the root of the module hierarchy. &quot;</span><span>
</span><a name="line-148"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; Also check that none of the modules are generated by parser generators or hsc files.&quot;</span><span>
</span><a name="line-149"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><a name="local-6989586621679366591"><a href="#local-6989586621679366591"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Failed to load interface&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366591"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-150"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Some of the required (external) modules cannot be loaded, because they are not found. Make sure that the project is &quot;</span><span>
</span><a name="line-151"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; already built, and that it is built using the same package database as it is used for refactoring.&quot;</span><span>
</span><a name="line-152"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><a name="local-6989586621679366592"><a href="#local-6989586621679366592"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Ambiguous interface&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679366592"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Some of the required (external) modules cannot be loaded, because they are ambiguous. &quot;</span><span>
</span><a name="line-154"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Since there is no separation between packages and package components, make sure that you do not depend &quot;</span><span>
</span><a name="line-155"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;on packages that contain modules with the same qualified name.&quot;</span><span>
</span><a name="line-156"></a><span class="hs-identifier">handleSourceProblem</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;While loading we found a compilation error in the source code. If it compiles normally &quot;</span><span>
</span><a name="line-158"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;using cabal or stack the problem might result from modules with same name, or &quot;</span><span>
</span><a name="line-159"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;generated files that are not up-to-date.&quot;</span><span>
</span><a name="line-160"></a></pre></body></html>